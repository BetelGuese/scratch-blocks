<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>Horizontal Playground</title>
    <script src="acorn_interpreter.js"></script>
    <script src="acorn.js"></script>

    <script src="../blockly_compressed_horizontal.js"></script>
    <script src="../javascript_compressed.js"></script>
    <script src="../blocks_common/math.js"></script>
    <script src="../blocks_horizontal/control.js"></script>
    <script src="../blocks_horizontal/event.js"></script>
    <script src="../blocks_horizontal/activity.js"></script>
    <script src="../blocks_horizontal/default_toolbox.js"></script>
    <script src="mysprite.js"></script>


    <script>
      'use strict';
      var Foo = {};
      Foo.canvas = null;
      var myInterpreter = null;
      var fakeDragStack = [];
      var workspace = null;
      var bgList = ['bg-desert.png', 
       'bg-hay-field.png', 'bg-moon.png', 'bg-stars.png', 'bg-underwater3.png', 
       'bg-night-city-with-street.png', 'goal1.png', 'slopes.svg'];
      var bgIndex = 0;
      var imageList = [];
      var imageFileList = ['cake-a.svg', 'penguin2.svg', 'ball-soccer.svg', 'dinosaur2-a.svg', 'donut.svg', 'fish3.svg', 'frog.svg',
        'monkey2-c.svg','shark-b.svg', 'spaceship-a.svg', 'taco-a.svg', 'unicorn.svg'];
      var imageIndex = 0;

      function start() {

        // Setup blocks
        // Parse the URL arguments.
        var toolbox = getToolboxElement();
        workspace = Blockly.inject('blocklyDiv', {
          comments: false,
          disable: false,
          collapse: false,
          media: '../media/',
          readOnly: false,
          rtl: false,
          scrollbars: true,
          toolbox: toolbox,
          trashcan: true,
          horizontalLayout: true,
          toolboxPosition: 'start',
          sounds: true,
          grid: {spacing: 16,
            length: 1,
            colour: '#2C344A',
            snap: false
          },
          zoom: {
            controls: true,
            wheel: true,
            startScale: 1.0,
            maxScale: 4,
            minScale: 0.25,
            scaleSpeed: 1.1
          },
          colours: {
            workspace: '#334771',
            flyout: '#283856',
            scrollbar: '#24324D',
            scrollbarHover: '#0C111A',
            insertionMarker: '#FFFFFF',
            insertionMarkerOpacity: 0.3,
            fieldShadow: 'rgba(255, 255, 255, 0.3)',
            dragShadowOpacity: 0.6
          }
        });
        loadImages();
        drawStuff();
      }

      function imageOnLoad(img) {
        var ctx = document.getElementById('myCanvas').getContext('2d');
          ctx.drawImage(img, 0, 0);
          ctx.clearRect(0, 0, 384, 512);
      }
      
      function loadImages() {
        // load images to canvas so they show up immediately when we try to draw.     
        for (var i = 0; i < imageFileList.length; i++) {
          var img = new Image();
          img.onload = function() {
            imageOnLoad(img);
          }
          img.src = Blockly.mainWorkspace.options.pathToMedia + imageFileList[i];
          imageList.push(img);
        }
      }

        function getToolboxElement() {
          var match = location.search.match(/toolbox=([^&]+)/);
          return document.getElementById('toolbox-' + (match ? match[1] : 'categories'));
        }

        function drawStuff() {
          Foo.canvas = new MyCanvas();
          Foo.canvas.clear();
          Foo.canvas.setBackground(bgList[bgIndex]);
          Foo.canvas.setSprite(new MySprite(Foo.canvas.cxt));
          Foo.canvas.redraw();
        }

        function moveButton() {
          Foo.canvas.moveSprite(20);
        }

        function turnButton() {
          Foo.canvas.rotateSprite(10);
        }
        
        function backgroundButton() {
          if (bgIndex < bgList.length - 1) {
            bgIndex ++;
          } else {
            bgIndex = 0;
          }
          Foo.canvas.setBackground(bgList[bgIndex]);
        }
        function spriteButton() {
          if (imageIndex < imageList.length - 1) {
            imageIndex ++;
          } else {
            imageIndex = 0;
          }
          Foo.canvas.changeSpriteImage(imageList[imageIndex]);
        }
        function getCodeFromStartBlock() {
           var topBlocks = workspace.getTopBlocks();
          var startBlock = null;
          for (var i = 0, block; block = topBlocks[i]; i++) {
            if (block.type == 'activity_start') {
              startBlock = block;
            }
          }
          var code =
              Blockly.JavaScript.blockToCode(startBlock);
          return code;
        }
        function codeButton() {
          var code = getCodeFromStartBlock();
          alert(code);
        }
      

    // Setup interpreter API.
    // rotateSprite
    // moveSprite
    // changeSprite
    // changeBackground
    function initApi(interpreter, scope) {
      var wrapper = function(steps) {
        Foo.canvas.rotateSprite(steps);
      };
      interpreter.setProperty(scope, 'rotateSprite',
          interpreter.createNativeFunction(wrapper));
    
      wrapper = function(steps) {
        Foo.canvas.moveSprite(steps);
      };
      interpreter.setProperty(scope, 'moveSprite',
          interpreter.createNativeFunction(wrapper));
      
      wrapper = function(index) {
        if (index == 99) {
          index =  Math.floor(Math.random() * imageList.length);
        }

        if (index >= imageList.length) {
          index = imageList.length - 1;
        } else if (index < 0) {
          index = 0;
        }
        Foo.canvas.changeSpriteImage(imageList[index]);
      };
      interpreter.setProperty(scope, 'changeSprite',
          interpreter.createNativeFunction(wrapper));
     
      wrapper = function(index) {
       if (index == 99) {
          index =  Math.floor(Math.random() * bgList.length);
        }
      
        if (index >= bgList.length) {
          index = bgList.length - 1;
        } else if (index < 0) {
          index = 0;
        }
        Foo.canvas.setBackground(bgList[index]);
      };
      interpreter.setProperty(scope, 'changeBackground',
          interpreter.createNativeFunction(wrapper));
    }
      
    function nextStep() {
      if (myInterpreter.step()) {
        window.setTimeout(nextStep, 10);
      };
    }

    function execCode() {
      // There's something weird about the generator setup here.  Somehow
      // calling workspaceToCode is actually doing some initialization that
      // blockToCode is not (e.g. variableDB_). Anyway, this call to
      // workspaceToCode solves the problem for now.
      var code = Blockly.JavaScript.workspaceToCode(workspace);
      var code = getCodeFromStartBlock();
      
      myInterpreter = new Interpreter(code, initApi);
      nextStep();
    }

    </script>

    <style>
      html, body {
        height: 100%;
      }

      body {
        background-color: #fff;
        font-family: sans-serif;
        overflow: hidden;
      }
      canvas {
        background: url('../media/bg-stars.png');
        background-size: contain;
        background-position: top;
        background-repeat: no-repeat;
      }
      h1 {
        font-weight: normal;
        font-size: 140%;
      }

      #blocklyDiv {
        height: 50%;
        width: 100%;
      }
      #canvasDiv {
        height: 50%;
        width: 100%;
      }
      #buttons {
        float:right;
      }

      #collaborators {
        float: right;
        width: 30px;
        margin-left: 10px;
      }

      #collaborators > img {
        margin-right: 5px;
        height: 30px;
        padding-bottom: 5px;
        width: 30px;
        border-radius: 3px;
      }

      #importExport {
        font-family: monospace;
      }
    </style>
  </head>

  <body onload="start()">
    <div id="collaborators"></div>
    <div id="blocklyDiv"></div>

    <div id="canvasDiv">
    <div id="buttons">
      <!--<button onclick='moveButton()' type="button"> move </button>
      <button onclick='turnButton()' type="button"> turn </button>
      <button onclick='backgroundButton()' type="button"> bg </button>
      <button onclick='spriteButton()' type="button"> sprite </button> -->
      <button onclick='codeButton()' type="button"> see code </button>
      <button onclick='execCode()' type="button"> run code </button>
    </div>
         <canvas id="myCanvas" height="384" width="512">
        </canvas>
    </div>
    <div id="hiddenStuff">
    </div>
  </body>
</html>
